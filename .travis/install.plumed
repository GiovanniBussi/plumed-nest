#! /bin/bash

set -e
set -x

suffix=""
version=""
repo=https://github.com/plumed/plumed2.git

for opt
do
case "$opt" in
  (version=*) version="${opt#version=}" ;;
  (suffix=*) suffix="--program-suffix=${opt#suffix=}" ;;
  (repo=*) repo="${opt#repo=}" ;;
  (*) echo "unknown option $opt" ; exit 1 ;;
esac
done

cd "$(mktemp -dt plumed.XXXXXX)"

git clone $repo
cd plumed2

if [ -n "$version" ] ; then
  echo "installing plumed $version"
else
  version=$(git tag --sort=-creatordate | grep '^v2\.[0-9][0-9]*\.[0-9][0-9]*' | head -n 1 )
  echo "installing latest stable plumed $version"
fi

git checkout $version

./configure --prefix=$HOME/opt  --enable-modules=all $suffix
make -j 5
make install
